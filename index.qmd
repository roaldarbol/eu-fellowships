---
title: |
  Fellowships <span style="font-size: 80% !important;">in the</span> \
  European Union
description-title: |
  A dashboard for EU fellowship opportunities with filtering and search capabilities.
format: 
  html:
    page-layout: full
    backgroundcolor: "#E6EEFF"
    css: styles.css
    header-includes: |
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
toc: false
title-block-banner: "linear-gradient(rgba(0, 51, 153, 1), rgba(230, 238, 255, 0.3)), url('assets/eu.jpg')"
---

```{r setup}
#| include: FALSE

# Load required packages
library(dplyr)
library(reactable)
library(htmltools)
library(jsonlite)
library(readxl)
library(crosstalk)
library(janitor)
library(stringr)
library(lubridate)
library(cli)

# Source filter functions
source("R/filters.R")
source("R/card_renderer.R")

set.seed(123)
```

```{r load-data}
#| include: FALSE
data <- vroom::vroom("data/eu-fellowships.csv")
```

```{r setup-crosstalk}
#| include: FALSE
# Create shared data objects for crosstalk filtering
shared_fellowships <- SharedData$new(data)
shared_countries <- SharedData$new(data, group = shared_fellowships$groupName())
shared_fields <- SharedData$new(data, group = shared_fellowships$groupName())
shared_career_stage <- SharedData$new(data, group = shared_fellowships$groupName())
```

```{r create-table}
#| include: FALSE

# Create the main reactable
fellowship_table <- reactable(
  shared_fellowships,
  filterable = FALSE,
  searchable = FALSE,
  highlight = FALSE,
  striped = FALSE,
  wrap = TRUE,
  class = "fellowship-table enhanced-cards",  # Added "enhanced-cards" class
  pagination = TRUE,
  defaultPageSize = 12,
  
  columns = list(
    fellowship_title = colDef(
      name = "Fellowships",
      cell = render_fellowship_card,
      html = TRUE
    ),
    # Hide all other columns
    id = colDef(show = FALSE),
    career_stage = colDef(show = FALSE),
    fellowship_funder = colDef(show = FALSE),
    fellowship_url = colDef(show = FALSE),
    fellowship_duration = colDef(show = FALSE),
    application_deadline = colDef(show = FALSE),
    eligible_host_location = colDef(show = FALSE),
    eligible_institution = colDef(show = FALSE),
    eligible_nationalities = colDef(show = FALSE),
    eligible_fields = colDef(show = FALSE),
    field_category_major = colDef(show = FALSE),
    field_category_minor = colDef(show = FALSE),
    requires_mobility = colDef(show = FALSE),
    requires_phd = colDef(show = FALSE),
    requires_publication = colDef(show = FALSE),
    minimum_years_post_phd = colDef(show = FALSE),
    maximum_years_in_postdoc = colDef(show = FALSE),
    contributor_name = colDef(show = FALSE),
    contributor_url = colDef(show = FALSE),
    date_created = colDef(show = FALSE)
  ),
  
  rowStyle = list(cursor = "default"),
  theme = reactableTheme(
    cellPadding = "0px",  # Removed padding to let cards handle their own spacing
    searchInputStyle = list(width = "100%")
  )
)
```

```{r create-ui}
#| echo: FALSE

# Assemble the complete UI
div(
  class = "fellowships",
  
  # Filter section
  tags$div(
    class = "filter-box",
    
    # Header with career stage filter
    tags$div(
      class = "header-with-radio",
      tags$h4(class = "filter-title", "Filter fellowships"),
      radio_filter(
        id = "filter_career_stage",
        label = "Career Stage",
        shared_data = shared_career_stage,
        group = "career_stage"
      )
    ),
    
    # Other filters
    tags$div(
      class = "filters",
      multi_select_filter(
        id = "filter_country",
        label = "Host countries",
        shared_data = shared_countries,
        group = "eligible_host_location",
        # custom_order = c("EU"),
        catchall_input = "Any EU country"
      ),
      multi_select_filter(
        id = "filter_field",
        label = "Academic fields",
        shared_data = shared_fields,
        group = "eligible_fields",
        catchall_input = "Any field"
      )
    )
  ),
  
  tags$hr(),
  
  # Fellowship cards table
  fellowship_table
)
```